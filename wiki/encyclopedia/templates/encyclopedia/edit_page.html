{% extends "encyclopedia/layout.html" %}

{% block title %}
Edit {{ title }}
{% endblock %}

{% block body %}
<h1>Edit {{ title }}</h1>
<form action="{% url 'edit_page' title=title %}" method="post">
    {% csrf_token %}
    <div class="form-group">
        {{ form.title.label_tag }}
        {{ form.title }}
    </div>
    <div class="form-group">
        {{ form.content.label_tag }}
        {{ form.content }}
    </div>
    <button type="submit" class="btn btn-primary">Save Changes</button>
</form>
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script>
    var simplemde = new SimpleMDE({
        element: document.getElementById("id_content"),
        toolbar: [
            "bold", "italic", "heading", "|",
            "quote", "unordered-list", "ordered-list", "|",
            {
                name: "insertLink",
                action: function customFunction(editor){
                    document.getElementById("linkInputWrapper").style.display = "block";
                },
                className: "fa fa-link",
                title: "Insert Link",
            },
            "preview", "side-by-side", "fullscreen"
        ],
        spellChecker: false
    });

    $(function() {
        $("#linkInput").autocomplete({
            source: function(request, response) {
                $.ajax({
                    url: "{% url 'get_entries' %}",
                    data: {
                        term: request.term
                    },
                    dataType: "json",
                    success: function(data) {
                        response(data);
                    }
                });
            },
            select: function(event, ui) {
                insertLink(ui.item.value);
            }
        });
    });

    function insertLink(value) {
        var cm = simplemde.codemirror;
        var doc = cm.getDoc();
        var cursor = doc.getCursor();
        doc.replaceRange("[" + value + "](/wiki/" + value + ")", cursor);
        document.getElementById('linkInputWrapper').style.display = 'none';
    }
</script>

<div id="linkInputWrapper" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background-color:white; padding:20px; border:1px solid black; z-index: 3;">
    <span style="font-size: 16pt; font-weight: bold;">Insert Link</span>
    <input style="margin-top: 10px; margin-bottom: 10px;" type="text" id="linkInput" class="form-control" placeholder="Search">
    <div style="position: absolute; top: 20px; right: 20px; cursor: pointer;" onclick="document.getElementById('linkInputWrapper').style.display='none';">
        <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 17.94 6M18 18 6.06 6"/>
        </svg>
    </div>
</div>
{% endblock %}
